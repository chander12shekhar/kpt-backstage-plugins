presubmits:
  - name: presubmit-kbp-test
    decorate: true
    always_run: true
    spec:
      containers:
        - image: node:16-alpine3.16
          command:
            - '/bin/sh'
            - '-c'
            - |
              set -euo pipefail
              yarn install --frozen-lockfile
              yarn test:all

  - name: presubmit-kbp-lint
    decorate: true
    always_run: true
    spec:
      containers:
        - image: node:16-alpine3.16
          command:
            - '/bin/sh'
            - '-c'
            - |
              set -euo pipefail
              yarn install --frozen-lockfile
              yarn lint:all
              yarn tsc:full
              yarn prettier:check

  - name: build-push-pre-image-kbp
    cluster: default
    always_run: true
    branches:
    - "main"
    annotations:
      description: Build and Push Presubmit Image to Hub
    decorate: true
    decoration_config:
      censor_secrets: true
    max_concurrency: 0
    spec:
      containers:
      - name: kaniko
        image: gcr.io/kaniko-project/executor:debug
        command:
        - "/bin/sh"
        - "-c"
        - |
          executor --context=${PWD} \
            --dockerfile=Dockerfile --destination=nephio/pre-kpt-backstage-plugins:${BUILD_ID}
        volumeMounts:
          - name: kaniko-secret
            mountPath: /kaniko/.docker/
        resources:
          requests:
            cpu: 2
            memory: 1Gi
      volumes:
        - name: kaniko-secret
          secret:
            secretName: regcred
            items:
              - key: .dockerconfigjson
                path: config.json